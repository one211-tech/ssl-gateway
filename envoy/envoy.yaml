# ============================================================================
# ENVOY GATEWAY — v1.31 COMPATIBLE WITH HOST REWRITE
# ============================================================================

admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901

static_resources:

  listeners:

  # --------------------------------------------------------------------------
  # INTERNAL HTTP LISTENER (PORT 8000) — SERVICE-TO-SERVICE COMMUNICATION
  # --------------------------------------------------------------------------
  - name: internal_listener
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 8000

    filter_chains:
      - filters:
        - name: envoy.filters.network.http_connection_manager
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
            stat_prefix: internal_http
            codec_type: AUTO

            access_log:
              - name: envoy.access_loggers.stdout
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                  log_format:
                    text_format: "[INTERNAL] %START_TIME% %REQ(:METHOD)% %REQ(:PATH)% %RESPONSE_CODE% %UPSTREAM_HOST%\n"

            route_config:
              name: internal_routes
              virtual_hosts:
                - name: internal_backend_service
                  domains:
                    - "*"
                  routes:
                    - match:
                        prefix: "/api/"
                      route:
                        cluster: backendcluster
                        timeout: 300s
                        host_rewrite_literal: "localhost"
                        retry_policy:
                          retry_on: "connect-failure,refused-stream,unavailable,cancelled,reset,retriable-status-codes"
                          retriable_status_codes:
                            - 503
                            - 502
                            - 504
                          num_retries: 3
                          per_try_timeout: 60s

                    - match:
                        prefix: "/actuator/"
                      route:
                        cluster: backendcluster
                        timeout: 30s
                        host_rewrite_literal: "localhost"
                        retry_policy:
                          retry_on: "connect-failure,refused-stream,unavailable,cancelled,reset"
                          num_retries: 2
                          per_try_timeout: 10s

                    - match:
                        prefix: "/"
                      route:
                        cluster: backendcluster
                        timeout: 300s
                        host_rewrite_literal: "localhost"
                        retry_policy:
                          retry_on: "connect-failure,refused-stream,unavailable,cancelled,reset,retriable-status-codes"
                          retriable_status_codes:
                            - 503
                            - 502
                            - 504
                          num_retries: 3
                          per_try_timeout: 60s

            http_filters:
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  # --------------------------------------------------------------------------
  # EXTERNAL HTTPS LISTENER (PORT 443)
  # --------------------------------------------------------------------------
  - name: https_listener
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 443

    filter_chains:
    - transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
          common_tls_context:
            tls_certificates:
              - certificate_chain:
                  filename: /etc/envoy/certs/fullchain.pem
                private_key:
                  filename: /etc/envoy/certs/privkey.pem
            alpn_protocols:
              - h2
              - http/1.1

      filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_https
          codec_type: AUTO

          upgrade_configs:
            - upgrade_type: websocket

          access_log:
            - name: envoy.access_loggers.stdout
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                log_format:
                  text_format: "[EXTERNAL] %START_TIME% %REQ(:METHOD)% %REQ(:AUTHORITY)%%REQ(:PATH)% %RESPONSE_CODE% %UPSTREAM_HOST%\n"

          route_config:
            name: external_routes
            virtual_hosts:

            # ================================================================
            # DAZZLEDUCK UI
            # ================================================================
            - name: dazzleduckservice
              domains:
                - "dazzleduck-ui.com"
                - "dazzleduck-ui.com:*"
                - "www.dazzleduck-ui.com"
                - "www.dazzleduck-ui.com:*"
              routes:
                - match:
                    prefix: "/"
                    headers:
                      - name: upgrade
                        present_match: true
                  route:
                    cluster: dazzleduckcluster
                    timeout: 0s
                - match:
                    prefix: "/"
                  route:
                    cluster: dazzleduckcluster
                    timeout: 300s
                    host_rewrite_literal: "localhost"

            # ================================================================
            # FRONTEND
            # ================================================================
            - name: frontendservice
              domains:
                - "frontend.one211.com"
                - "frontend.one211.com:*"
                - "www.one211.com"
                - "www.one211.com:*"
              routes:
                - match:
                    prefix: "/"
                    headers:
                      - name: upgrade
                        present_match: true
                  route:
                    cluster: frontendcluster
                    timeout: 0s

                - match:
                    prefix: "/api/"
                  route:
                    cluster: backendcluster
                    timeout: 300s
                    host_rewrite_literal: "localhost"
                    retry_policy:
                      retry_on: "connect-failure,refused-stream,unavailable,cancelled,reset,retriable-status-codes"
                      retriable_status_codes:
                        - 503
                        - 502
                        - 504
                      num_retries: 3
                      per_try_timeout: 60s

                - match:
                    prefix: "/"
                  route:
                    cluster: frontendcluster
                    timeout: 300s
                    host_rewrite_literal: "localhost"
                    retry_policy:
                      retry_on: "connect-failure,refused-stream,unavailable,cancelled,reset"
                      num_retries: 2
                      per_try_timeout: 30s

            # ================================================================
            # BACKEND DIRECT
            # ================================================================
            - name: backendservice
              domains:
                - "backend.one211.com"
                - "backend.one211.com:*"
              routes:
                - match:
                    prefix: "/"
                  route:
                    cluster: backendcluster
                    timeout: 300s
                    host_rewrite_literal: "localhost"
                    retry_policy:
                      retry_on: "connect-failure,refused-stream,unavailable,cancelled,reset,retriable-status-codes"
                      retriable_status_codes:
                        - 503
                        - 502
                        - 504
                      num_retries: 3
                      per_try_timeout: 60s

            # ================================================================
            # SQL CONTROLLER 1
            # ================================================================
            - name: controllerservice
              domains:
                - "controller.one211.com"
                - "controller.one211.com:*"
              routes:
                - match:
                    prefix: "/"
                    headers:
                      - name: ":method"
                        exact_match: "OPTIONS"
                  direct_response:
                    status: 204
                  response_headers_to_add:
                    - header:
                        key: Access-Control-Allow-Origin
                        value: "*"
                    - header:
                        key: Access-Control-Allow-Methods
                        value: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
                    - header:
                        key: Access-Control-Allow-Headers
                        value: "Authorization, Content-Type"
                - match:
                    prefix: "/"
                  route:
                    cluster: controller1httpcluster
                    timeout: 300s
                    host_rewrite_literal: "localhost"
                  response_headers_to_add:
                    - header:
                        key: Access-Control-Allow-Origin
                        value: "https://dazzleduck-ui.com"
                      append_action: OVERWRITE_IF_EXISTS_OR_ADD
                    - header:
                        key: Access-Control-Allow-Methods
                        value: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
                      append_action: OVERWRITE_IF_EXISTS_OR_ADD
                    - header:
                        key: Access-Control-Allow-Headers
                        value: "Authorization, Content-Type"
                      append_action: OVERWRITE_IF_EXISTS_OR_ADD

            # ================================================================
            # SQL CONTROLLER 2
            # ================================================================
            - name: controller2service
              domains:
                - "controller2.one211.com"
                - "controller2.one211.com:*"
              routes:
                - match:
                    prefix: "/"
                    headers:
                      - name: ":method"
                        exact_match: "OPTIONS"
                  direct_response:
                    status: 204
                  response_headers_to_add:
                    - header:
                        key: Access-Control-Allow-Origin
                        value: "*"
                    - header:
                        key: Access-Control-Allow-Methods
                        value: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
                    - header:
                        key: Access-Control-Allow-Headers
                        value: "Authorization, Content-Type"
                - match:
                    prefix: "/"
                  route:
                    cluster: controller2httpcluster
                    timeout: 300s
                    host_rewrite_literal: "localhost"
                  response_headers_to_add:
                    - header:
                        key: Access-Control-Allow-Origin
                        value: "https://dazzleduck-ui.com"
                      append_action: OVERWRITE_IF_EXISTS_OR_ADD
                    - header:
                        key: Access-Control-Allow-Methods
                        value: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
                      append_action: OVERWRITE_IF_EXISTS_OR_ADD
                    - header:
                        key: Access-Control-Allow-Headers
                        value: "Authorization, Content-Type"
                      append_action: OVERWRITE_IF_EXISTS_OR_ADD

          http_filters:
            - name: envoy.filters.http.router
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  # --------------------------------------------------------------------------
  # FLIGHT TCP PROXY 1
  # --------------------------------------------------------------------------
  - name: flight_listener_1
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 59307
    filter_chains:
      - filters:
          - name: envoy.filters.network.tcp_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
              stat_prefix: flight_tcp_1
              cluster: controller1flightcluster

  # --------------------------------------------------------------------------
  # FLIGHT TCP PROXY 2
  # --------------------------------------------------------------------------
  - name: flight_listener_2
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 59301
    filter_chains:
      - filters:
          - name: envoy.filters.network.tcp_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
              stat_prefix: flight_tcp_2
              cluster: controller2flightcluster

  # ==========================================================================
  # CLUSTERS (No underscores in names)
  # ==========================================================================

  clusters:

  # --------------------------------------------------------------------------
  # DAZZLEDUCK CLUSTER
  # --------------------------------------------------------------------------
  - name: dazzleduckcluster
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: dazzleduckcluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: dazzleduck-ui
                    port_value: 5174

  # --------------------------------------------------------------------------
  # FRONTEND CLUSTER (FAULT TOLERANT - 2 INSTANCES)
  # --------------------------------------------------------------------------
  - name: frontendcluster
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: RING_HASH
    common_lb_config:
      consistent_hashing_lb_config: {}
    load_assignment:
      cluster_name: frontendcluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: frontend
                    port_value: 5173
                health_check_config:
                  port_value: 5173
            - endpoint:
                address:
                  socket_address:
                    address: frontend2
                    port_value: 5173
                health_check_config:
                  port_value: 5173
    health_checks:
      - timeout: 5s
        interval: 10s
        unhealthy_threshold: 3
        healthy_threshold: 2
        http_health_check:
          path: "/"
          expected_statuses:
            - start: 200
              end: 399
    outlier_detection:
      consecutive_5xx: 3
      interval: 10s
      base_ejection_time: 30s
      max_ejection_percent: 50
      enforcing_consecutive_5xx: 100
    circuit_breakers:
      thresholds:
        - priority: DEFAULT
          max_connections: 1000
          max_pending_requests: 1000
          max_requests: 1000
          max_retries: 3

  # --------------------------------------------------------------------------
  # BACKEND CLUSTER (FAULT TOLERANT - 2 INSTANCES)
  # --------------------------------------------------------------------------
  - name: backendcluster
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: backendcluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: backend
                    port_value: 8080
                health_check_config:
                  port_value: 8080
            - endpoint:
                address:
                  socket_address:
                    address: backend2
                    port_value: 8080
                health_check_config:
                  port_value: 8080
    health_checks:
      - timeout: 5s
        interval: 10s
        unhealthy_threshold: 3
        healthy_threshold: 2
        http_health_check:
          path: "/actuator/health"
          expected_statuses:
            - start: 200
              end: 299
    outlier_detection:
      consecutive_5xx: 3
      interval: 10s
      base_ejection_time: 30s
      max_ejection_percent: 50
      enforcing_consecutive_5xx: 100
    circuit_breakers:
      thresholds:
        - priority: DEFAULT
          max_connections: 1000
          max_pending_requests: 1000
          max_requests: 1000
          max_retries: 3

  # --------------------------------------------------------------------------
  # SQL CONTROLLER CLUSTERS
  # --------------------------------------------------------------------------
  - name: controller1httpcluster
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: controller1httpcluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: sql-controller
                    port_value: 9006

  - name: controller2httpcluster
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: controller2httpcluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: sql-controller2
                    port_value: 9007

  - name: controller1flightcluster
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: controller1flightcluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: sql-controller
                    port_value: 59307

  - name: controller2flightcluster
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: controller2flightcluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: sql-controller2
                    port_value: 59301
